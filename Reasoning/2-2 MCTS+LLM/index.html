
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="DeepSeek 系列工作解读、扩展和复现。">
      
      
        <meta name="author" content="Unlock-DeepSeek Team">
      
      
        <link rel="canonical" href="https://datawhalechina.github.io/unlock-deepseek/Reasoning/2-2%20MCTS%2BLLM/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>蒙特卡洛树搜索与大语言模型的结合 - Unlock-DeepSeek</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Unlock-DeepSeek" class="md-header__button md-logo" aria-label="Unlock-DeepSeek" data-md-component="logo">
      
  <img src="../../images/small_datawhale_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Unlock-DeepSeek
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              蒙特卡洛树搜索与大语言模型的结合
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red"  aria-label="切换至夜间模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至夜间模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="yellow"  aria-label="切换至日间模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至日间模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/datawhalechina/unlock-deepseek" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    datawhalechina/unlock-deepseek
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  项目介绍

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../MoE/MoE历史脉络回顾.md" class="md-tabs__link">
          
  
  MoE

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Reasoning_Models/蒙特卡洛树搜索MCTS.md" class="md-tabs__link">
          
  
  Reasoning Models

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Keys/DeepSeek成本为什么这么低/README.md" class="md-tabs__link">
          
  
  Keys

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://datawhale.cn/" class="md-tabs__link">
        
  
    
  
  关于 Datawhale

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Unlock-DeepSeek" class="md-nav__button md-logo" aria-label="Unlock-DeepSeek" data-md-component="logo">
      
  <img src="../../images/small_datawhale_logo.png" alt="logo">

    </a>
    Unlock-DeepSeek
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/datawhalechina/unlock-deepseek" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    datawhalechina/unlock-deepseek
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    项目介绍
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    MoE
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            MoE
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../MoE/MoE历史脉络回顾.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MoE历史脉络回顾
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reasoning Models
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reasoning Models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Reasoning_Models/蒙特卡洛树搜索MCTS.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    蒙特卡洛树搜索MCTS
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Keys
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Keys
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Keys/DeepSeek成本为什么这么低/README.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeepSeek成本为什么这么低
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://datawhale.cn/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于 Datawhale
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 引言
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 蒙特卡洛树搜索
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-uct" class="md-nav__link">
    <span class="md-ellipsis">
      3. UCT 选择决策
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 代码框架
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 代码框架">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mcts" class="md-nav__link">
    <span class="md-ellipsis">
      MCTS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#selection" class="md-nav__link">
    <span class="md-ellipsis">
      选择 (Selection)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expansion" class="md-nav__link">
    <span class="md-ellipsis">
      拓展 (Expansion)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simulation" class="md-nav__link">
    <span class="md-ellipsis">
      模拟 (Simulation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#backpropagation" class="md-nav__link">
    <span class="md-ellipsis">
      回溯 (Backpropagation)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rollout" class="md-nav__link">
    <span class="md-ellipsis">
      Rollout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choose-argmax_ain-asqs_0a" class="md-nav__link">
    <span class="md-ellipsis">
      Choose \(\arg\max_{a\in A(s)}Q(s_0,a)\)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-puct" class="md-nav__link">
    <span class="md-ellipsis">
      5. PUCT 选择决策
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. PUCT 选择决策">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mcts_1" class="md-nav__link">
    <span class="md-ellipsis">
      与传统MCTS的差异
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-llm-mcts" class="md-nav__link">
    <span class="md-ellipsis">
      6. LLM + MCTS 推理决策
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. LLM + MCTS 推理决策">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm-mcts" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 与 MCTS 结合的难点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      实际应用中如何定义状态、动作、奖励
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rap" class="md-nav__link">
    <span class="md-ellipsis">
      RAP
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      如何高效地构建动作空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rstar" class="md-nav__link">
    <span class="md-ellipsis">
      rStar
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      如何进行过程验证和评估
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-mcts-llm" class="md-nav__link">
    <span class="md-ellipsis">
      7. MCTS 优化 LLM 训练
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. MCTS 优化 LLM 训练">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      如何评估推理步骤的质量，自动标注推理过程的标签
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#math-shepherd" class="md-nav__link">
    <span class="md-ellipsis">
      MATH-SHEPHERD
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#offline-learning" class="md-nav__link">
    <span class="md-ellipsis">
      如何自动获取高质量推理路径，并有效处理奖励信号以进行验证和 offline learning 自我训练
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rest-mcts" class="md-nav__link">
    <span class="md-ellipsis">
      ReST-MCTS*
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#alphazero-llm" class="md-nav__link">
    <span class="md-ellipsis">
      把 AlphaZero 的策略迁移到 LLM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#super_mario" class="md-nav__link">
    <span class="md-ellipsis">
      Super_MARIO
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="_1">蒙特卡洛树搜索与大语言模型的结合<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h3 id="1">1. 引言<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>由于 AlphaGo/AlphaZero 的巨大成功，在讨论 o1-like 模型时，研究者们都猜测 MCTS 是其成功的关键组件，它不仅可以在推理阶段优化决策过程，又可以产生训练数据迭代训练，所以，我们需要了解 MCTS 都是怎么与 LLM 结合使用：</p>
<ul>
<li><strong>提高复杂问题推理能力</strong>：使用 MCTS 扩充模型的搜索空间，使其得到更加多样的答案，然后使用相关的算法选择置信度最高的作为最终结果</li>
<li><strong>优化训练数据</strong>：使用 MCTS 进行数据增强，然后将新数据用于模型迭代</li>
</ul>
<h3 id="2">2. 蒙特卡洛树搜索<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>蒙特卡洛树搜索 (Monte Carlo tree search, MCTS) 是一种用于某些决策过程的启发式搜索算法，常用于解决博弈树问题，该算法是在线的，即动作选择和动作执行交错进行。</p>
<p>MCTS 基于搜索空间的随机采样扩展搜索树，其基本过程是使用模拟来构建一棵树。已评估的状态存储在搜索树中，评估状态集是通过迭代以下四个步骤逐步构建的：</p>
<p>$$
Rollout = Select + Expand + Simulate + Backpropagate
$$
<a class="glightbox" href="../../images/2-2-01.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-01.png" /></a></p>
<ol>
<li><strong>选择(Selection)</strong>：从根节点（当前游戏状态）开始，使用一种策略（如UCT算法）来沿着树向下选择连续的子节点，直到到达叶节点。其中，UCT算法平衡了探索（exploration）和利用（exploitation），每次选择具有最高 UCB1 值的子节点；</li>
<li><strong>拓展(Expansion)</strong>：除非最终到达的节点是终止状态，否则在选定的叶子节点上扩展树，添加一个或多个新的子节点，每个子节点代表一个可能的合法移动。然后，从这些新节点中选择一个节点 C 进行下一步操作；</li>
<li><strong>模拟(Simulation)</strong>：从扩展的节点C开始，进行一次随机模拟，直到游戏结束。在模拟过程中，随机选择移动，直到达到终止节点，模拟的结果用于评估节点 C 的价值；</li>
<li><strong>回溯(Backpropagation)</strong>：将模拟的结果从叶子节点 C 反向传播回根节点，更新路径上所有节点的统计信息。根据模拟的结果，更新路径上每个节点的收益和访问次数。</li>
</ol>
<p>一次 Rollout 为执行一轮 <strong>Select + Expand + Simulate + Backpropagate</strong> 的过程。</p>
<h3 id="3-uct">3. UCT 选择决策<a class="headerlink" href="#3-uct" title="Permanent link">&para;</a></h3>
<p>选择决策主要使用了 UCT (Upper Confidence bounds applied to Trees) 算法，UCT 算法是 MCTS 与 UCB1 策略的结合，即 UCT = MCTS + UCB1。</p>
<p>UCB (Upper Confidence Bound, 置信区间上界)：在博弈树的每个节点中应选择值最大的节点 (UCB1)</p>
<div class="arithmatex">\[
UCB(i)=\frac{q_i}{n_i}+c\sqrt{\frac{\ln N_i}{n_i}}
\]</div>
<div class="arithmatex">\[
$$a^*=\arg\max_{a\in A(s)}\{Q(s,a)+c\sqrt{\frac{\ln N(s)}{N(s,a)}}\}
\]</div>
<ul>
<li><span class="arithmatex">\(q_i\)</span>：表示节点 <span class="arithmatex">\(i\)</span> 的收益</li>
<li><span class="arithmatex">\(n_i\)</span>: 表示节点 <span class="arithmatex">\(i\)</span> 的访问次数</li>
<li><span class="arithmatex">\(c\)</span>: 探索参数，理论值为 <span class="arithmatex">\(\sqrt{2}\)</span>，用于对探索 (exploration) 和利用 (exploitation) 的平衡</li>
<li><span class="arithmatex">\(N_i\)</span>: 表示节点 <span class="arithmatex">\(i\)</span> 的父节点的访问次数</li>
</ul>
<p>其中加号前面是该节点当前的收益均值，后面的本质上是均值的标准差。这个公式反映：收益均值越大，被选中的概率越大，起到了 exploit 的作用；同时第二项使得那些被选次数较少的节点也会得到试验机会，起到了 explore 的作用。</p>
<h3 id="4">4. 代码框架<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<h4 id="mcts">MCTS<a class="headerlink" href="#mcts" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">MCTS</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="s2">&quot;Monte Carlo tree searcher. First rollout the tree then choose a move.&quot;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exploration_weight</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># total reward of each node</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># total visit count for each node</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># children of each node</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exploration_weight</span> <span class="o">=</span> <span class="n">exploration_weight</span>
</code></pre></div></td></tr></table></div>
<h4 id="selection">选择 (Selection)<a class="headerlink" href="#selection" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span>
<span class="normal"><a href="#__codelineno-1-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="c1"># (node 未被扩展) 或 (node 为终止节点)</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>            <span class="k">return</span> <span class="n">path</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="n">unexplored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="k">if</span> <span class="n">unexplored</span><span class="p">:</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>            <span class="n">n</span> <span class="o">=</span> <span class="n">unexplored</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>            <span class="k">return</span> <span class="n">path</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uct_select</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> 
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="k">def</span><span class="w"> </span><span class="nf">_uct_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>    <span class="n">log_N_vertex</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">uct</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">exploration_weight</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>                   <span class="n">log_N_vertex</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>               <span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">uct</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="expansion">拓展 (Expansion)<a class="headerlink" href="#expansion" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>        <span class="k">return</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find_children</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h4 id="simulation">模拟 (Simulation)<a class="headerlink" href="#simulation" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span>
<span class="normal"><a href="#__codelineno-3-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">():</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>            <span class="n">reward</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">reward</span><span class="p">()</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>        <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find_random_child</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<h4 id="backpropagation">回溯 (Backpropagation)<a class="headerlink" href="#backpropagation" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_backpropagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">reward</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reward</span>
</code></pre></div></td></tr></table></div>
<h4 id="rollout">Rollout<a class="headerlink" href="#rollout" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span>
<span class="normal"><a href="#__codelineno-5-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">do_rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="n">leaf</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_expand</span><span class="p">(</span><span class="n">leaf</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulate</span><span class="p">(</span><span class="n">leaf</span><span class="p">)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_backpropagate</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="choose-argmax_ain-asqs_0a">Choose  <span class="arithmatex">\(\arg\max_{a\in A(s)}Q(s_0,a)\)</span><a class="headerlink" href="#choose-argmax_ain-asqs_0a" title="Permanent link">&para;</a></h4>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span>
<span class="normal"><a href="#__codelineno-6-7">7</a></span>
<span class="normal"><a href="#__codelineno-6-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">choose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">find_random_child</span><span class="p">()</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">node</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="5-puct">5. PUCT 选择决策<a class="headerlink" href="#5-puct" title="Permanent link">&para;</a></h3>
<p>传统的 MCTS 一个明显的缺点是Q(s,a)需要执行完整的 Simulation 操作。</p>
<p>在 AlphaZero 中，选择策略使用了UCT的变体，PUCT（Predictor Upper Confidence Bound for Trees）：</p>
<div class="arithmatex">\[
a^*=\arg\max_{a\in A(s)}\left[Q(s,a)+c_{puct}P(s,a)\frac{\sqrt{\sum_b N(s,b)}}{1+N(s,a)}\right]
\]</div>
<p>其中，前半部分鼓励模型选择得分高的动作，后半部分鼓励模型探索，P(s,a)为动作概率，用于提升探索的效率，<span class="arithmatex">\(c_{puct}\)</span>同样是平衡因子，用于平衡探索和利用。</p>
<p>当选择一个叶子结点<span class="arithmatex">\(s_t\)</span>时，需要对叶子节点进行扩展和评估，不同于传统的 MCTS，AlphaZero 用神经网络的预测<span class="arithmatex">\(V(s_t)\)</span>代替了 Simulation（同时也预测<span class="arithmatex">\(P(s_t|\cdot)\)</span>），这样显然提升了搜索的效率。</p>
<p>回溯过程中，用<span class="arithmatex">\(V(s_t)\)</span>来更新从根结点到叶子结点的所有<span class="arithmatex">\(Q(s,a)\)</span>：</p>
<div class="arithmatex">\[
N(s,a) \leftarrow N(s,a)+1
\]</div>
<div class="arithmatex">\[
Q(s,a) \leftarrow \frac{1}{N(s,a)}\sum_{j=1}^i I_{s,a \rightarrow s_t}V(s_t)^{(j)}
\]</div>
<h4 id="mcts_1">与传统MCTS的差异<a class="headerlink" href="#mcts_1" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p>传统 MCTS 方法中，<span class="arithmatex">\(Q(s,a)\)</span>基于完整 Simulation 得到的估计值。而 AlphaZero 直接用神经网络估计<span class="arithmatex">\(V(s_t)\)</span>，从而能够有效减少搜索的深度，大大提高了估计的效率。</p>
</li>
<li>
<p>传统 MCTS 方法中，探索项的分子仅仅是访问次数，与状态动作对<span class="arithmatex">\((s,a)\)</span>的性质无关。AlphaZero 考虑到了在人类专家经验中，不同的状态动作对<span class="arithmatex">\((s,a)\)</span>出现的先验概率<span class="arithmatex">\(P(s,a)\)</span>，有效地减少了搜索的宽度。</p>
</li>
</ol>
<h3 id="6-llm-mcts">6. LLM + MCTS 推理决策<a class="headerlink" href="#6-llm-mcts" title="Permanent link">&para;</a></h3>
<h4 id="llm-mcts">LLM 与 MCTS 结合的难点<a class="headerlink" href="#llm-mcts" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>广阔的搜索空间</strong>，由于词表或者句子的组合情况非常巨大，导致搜索效率较低</li>
<li><strong>模糊的反馈</strong>，语言模型有可能存在多个 token 都合适，或者多种语言表达都合理的情况，没有绝对的正确和错误，导致反馈信息模糊</li>
</ul>
<h4 id="_2">实际应用中如何定义状态、动作、奖励<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<h4 id="rap">RAP<a class="headerlink" href="#rap" title="Permanent link">&para;</a></h4>
<blockquote>
<p>LLM（作为推理者）在 LLM（作为世界模型）和任务特定奖励的指导下逐步构建推理树，并在广度与深度之间取得适当的平衡，从而有效地获得高奖励推理路径</p>
</blockquote>
<p><a class="glightbox" href="../../images/2-2-02.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-02.png" /></a></p>
<p><strong>三种应用示例</strong></p>
<p><a class="glightbox" href="../../images/2-2-03.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-03.png" /></a></p>
<ol>
<li>
<p><strong>RAP用于 Blocksworld 中的计划生成</strong></p>
</li>
<li>
<p>状态：块到目前为止的状态</p>
</li>
<li>动作：对块的四种操作（STACK、UNSTACK、PUT 和 PICKUP）</li>
<li>奖励：首先用一些示例测试用例及其解决方案提示 LLM，然后计算给定当前状态下动作的对数概率，表示为 r1。当离目标只剩几步时，它通常比较准确，而对于遥远的目标则不那么可靠。此外，将执行动作后的新状态与目标进行比较，并提供奖励 r2，与满足条件的块的数目成比例</li>
</ol>
<p><a class="glightbox" href="../../images/2-2-04.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-04.png" /></a></p>
<ol>
<li><strong>GSM8K 中的数学推理</strong></li>
<li>状态：定义为中间变量</li>
<li>动作：是提出关于新中间变量的增量子问题</li>
<li>奖励：将 LLM 对上个动作的有用性自评和当前状态的置信度相结合，这个奖励函数鼓励提出更相关且有用的子问题</li>
</ol>
<p><a class="glightbox" href="../../images/2-2-05.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-05.png" /></a></p>
<ol>
<li>
<p><strong>PrOntoQA 中的逻辑推理</strong></p>
</li>
<li>
<p>状态：关注的事实，类似于人类用于推理的工作记忆</p>
</li>
<li>动作：定义为从事实集中选择一个规则</li>
<li>奖励：通过自我评估计算，具体来说，用一些带有标签的例子来提示 LLM，以帮助它更好地理解推理步骤的质量</li>
</ol>
<p><a class="glightbox" href="../../images/2-2-06.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-06.png" /></a></p>
<h4 id="_3">如何高效地构建动作空间<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<h4 id="rstar">rStar<a class="headerlink" href="#rstar" title="Permanent link">&para;</a></h4>
<blockquote>
<p>按照人类的思维方式，总结出了可能采用的 5 种解决问题的方法，构造一颗搜索树</p>
</blockquote>
<p>MCTS 的作用主要是将复杂问题拆分成多个或者多步执行的子问题，其依据是设定的动作空间，即树搜索的范围。而 LLM 的作用是根据指定的动作生成候选答案或者生成评估验证的反馈，那么存在的问题是 LLM 输出通常是无限、连续的动作空间。那么如何设置动作空间以保证既充分又完备</p>
<p><a class="glightbox" href="../../images/2-2-07.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-07.png" /></a></p>
<p><strong>A1（propose a one-step-thought）</strong></p>
<p>每次提出一个推理step，直到生成最后的答案。每个step的形式是 <strong>"该step的推理文字+该step的答案"</strong>，最后一个step以"The answer is"开头，表示产出了原始问题的最终答案：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>Instruction:
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>There are 15 trees in the grove. Grove workers will plant trees in the grove today. After they are done, there will be 21 trees. How many trees did the grove workers plant today?
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>Response:
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>Let&#39;s think step by step.
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>Step 1: Identify the initial number of trees. The problem states there are 15 trees in the grove.
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>Step 2: Identify the final number of trees. The problem states there will be 21 trees after the workers are done planting.
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>Step 3: Subtract the initial number of trees from the final number of trees to find out how many trees were planted.
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>Step 4: Therefore, the grove workers planted 21 (final number of trees) - 15 (initial number of trees) = 6 trees today.
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>Step 5: The answer is 6.
</code></pre></div></td></tr></table></div>
<p><strong>A2（propose the remaining thought steps）</strong></p>
<p>对于简单的问题，并不需要步步思考，可以一次性通过一些简单的推理后直接给出答案：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>Instruction:
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>There are 15 trees in the grove. Grove workers will plant trees in the grove today. After they are done, there will be 21 trees. How many trees did the grove workers plant today?
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>Response:
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>Let&#39;s think step by step. There are 15 trees originally. Then there were 21 trees after some more were planted. So there must have been 21 - 15 = 6. The answer is: 6.
</code></pre></div></td></tr></table></div>
<p><strong>A3 (propose next sub-question along with its answer)</strong></p>
<p>把原始问题拆解成很多子问题，然后回答一个个子问题，最终给出答案，例如：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>Question 1: Four years ago, Kody was only half as old as Mohamed. If Mohamed is currently twice as 30 years old, how old is Kody?
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>Question 1.1: How old is Mohamed currently?
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>Answer 1.1: Mohamed is twice as old as 30 years, which means he is 30 * 2 = 60 years old. 
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>Question 1.2: What was Kody&#39;s age four years ago, given that it was half of Mohamed&#39;s age at that time?
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>Answer 1.2: Four years ago, Mohamed was 60 - 4 = 56 years old, so Kody was half of that, which is 56 / 2 = 28 years old.
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>Question 1.3: Now we can answer the question: How old is Kody?
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>Answer 1.3: Kody is currently 28 + 4 = 32 years old. The answer is 32.
</code></pre></div></td></tr></table></div>
<p>其中，Question 1.3属于终结类型的子问题，因为回答它就等于回答了最终答案。</p>
<p><strong>A4 (Answer the sub-question again)</strong></p>
<p>与A3搭配使用，例如，对于A3的Question1.1，并不确定Answer1.1是否正确，此时重新再思考一次Answer1.1的答案。由于只是对某一个子答案做修正，可以采用A2的方式，做一些简单的推理，重新取得Answer1.1，相当于把Answer1.1用做一次A2得到的输出结果进行替代：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>Question 1: Four years ago, Kody was only half as old as Mohamed. If Mohamed is currently twice as 30 years old, how old is Kody?
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>Question 1.1: How old is Mohamed currently?
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>Answer 1.1: Mohamed is twice as old as 30 years, which means he is 30 * 2 = 60 years old. 
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>Question 1.2: What was Kody&#39;s age four years ago, given that it was half of Mohamed&#39;s age at that time?
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>Answer 1.2: Mohamed was 60 years old, so Kody was half of that, which is 60 / 2 = 30 years old.
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>(
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>### Instruction:
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>Four years ago, Kody was only half as old as Mohamed. If Mohamed is currently twice as 30 years old, what was Kody&#39;s age four years ago?
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>### Response:
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>Let&#39;s think step by step. Mohamed is twice as old as 30 years, which means he is 30 * 2 = 60 years old. Four years ago, Mohamed was 60 - 4 = 56 years old, so Kody was half of that, which is 56 / 2 = 28 years old.
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>)
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>Revised Answer 1.2: Let&#39;s think step by step. Mohamed is twice as old as 30 years, which means he is 30 * 2 = 60 years old. Four years ago, Mohamed was 60 - 4 = 56 years old, so Kody was half of that, which is 56 / 2 = 28 years old.
</code></pre></div></td></tr></table></div>
<p><strong>A5（Rephrase the question/sub-question）</strong></p>
<p>在大段的原始题目描述中，把关键信息提取出来，例如：Condition1..., Condition2等等。可以先通过这种方式改写原始题目/子题目，然后再做回答：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a>Original Question: Olivia has $23. She bought five bagels for $3 each. How much money does she have left?
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>Rephrased Question: Given a list of conditions, please answer the question. 
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>Condition 1: Olivia starts with $23. 
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>Condition 2: She buys five bagels, each costing $3. 
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>Question: How much money does Olivia have remaining after her purchase?
</code></pre></div></td></tr></table></div>
<h4 id="_4">如何进行过程验证和评估<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>过程监督可以说是 MCTS + LLM 中的关键步骤，无论生成的结果是否正确，无法有效评估和判断，则同样是没有价值的，当前的过程评估方法大概有以下几种：</p>
<ul>
<li><strong>专家式</strong>：使用另一个更好的（当然也可以是本身）的 LLM 作为专家来判断生成的结果是否正确、合理</li>
<li><strong>集成式</strong>：类似于集成学习的方法，即同时生成多个答案，通过答案之间的一致性来进行判断 （rStar 采用同行评审般的一致性选择）</li>
<li><strong>奖励式</strong>：即专门训练一个 PRM 来为结果进行打分，其思想即源于 RL 的 reward model</li>
</ul>
<h3 id="7-mcts-llm">7. MCTS 优化 LLM 训练<a class="headerlink" href="#7-mcts-llm" title="Permanent link">&para;</a></h3>
<h4 id="_5">如何评估推理步骤的质量，自动标注推理过程的标签<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<h4 id="math-shepherd">MATH-SHEPHERD<a class="headerlink" href="#math-shepherd" title="Permanent link">&para;</a></h4>
<blockquote>
<p>基于 MCTS 中 simulate 的思想，将推理步骤的质量定义为 '它推断正确答案的潜力'，使用多次随机 Simulate 标注推理过程的标签，用于训练一个好的 PRM</p>
</blockquote>
<p><strong>Outcome Reward Model &amp; Process Reward Model</strong></p>
<div class="arithmatex">\[L_{ORM} = y_s \log r_s + (1-y_s) \log(1-r_s)\]</div>
<p>其中<span class="arithmatex">\(y_s\)</span>是标准答案，<span class="arithmatex">\(y_s=1\)</span>表示正确，<span class="arithmatex">\(y_s=0\)</span>表示错误。</p>
<div class="arithmatex">\[L_{PRM} = \sum_{i=1}^K y_{s_i} \log r_{s_i} + (1-y_{s_i}) \log(1-r_{s_i})\]</div>
<p>其中<span class="arithmatex">\(y_{s_i}\)</span>是标准答案，<span class="arithmatex">\(y_{s_i}=1\)</span>表示步骤<span class="arithmatex">\(s_i\)</span>正确，<span class="arithmatex">\(y_{s_i}=0\)</span>表示步骤<span class="arithmatex">\(s_i\)</span>错误。</p>
<p><a class="glightbox" href="../../images/2-2-08.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-08.png" /></a></p>
<p><strong>Hard Estimation (HE)</strong></p>
<div class="arithmatex">\[y_{s_i}^{HE} = \begin{cases} 
1 &amp; \exists a_j \in A, a_j = a^* \\
0 &amp; \text{Otherwise}
\end{cases}\]</div>
<p><strong>Soft Estimation (SE)</strong></p>
<div class="arithmatex">\[y_{s_i}^{SE} = \frac{1}{N}\sum_{j=1}^N I(a_j = a^*)\]</div>
<p><strong>Ranking for Verification (Self-Consistency + Reward Model)</strong></p>
<div class="arithmatex">\[a_{sc+rm} = \arg\max_a \sum_{i=1}^N I(a_i = a) \cdot RM(p, S_i)\]</div>
<p><a class="glightbox" href="../../images/2-2-09.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-09.png" /></a></p>
<p><a class="glightbox" href="../../images/2-2-10.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-10.png" /></a></p>
<h4 id="offline-learning">如何自动获取高质量推理路径，并有效处理奖励信号以进行验证和 offline learning 自我训练<a class="headerlink" href="#offline-learning" title="Permanent link">&para;</a></h4>
<h4 id="rest-mcts">ReST-MCTS*<a class="headerlink" href="#rest-mcts" title="Permanent link">&para;</a></h4>
<blockquote>
<p>使用 MCTS 优化 LLM 的训练，不同于 AlphaGo 中 MCTS + RL 的 online learning 的形式，而是 offline learning 的形式，即通过产生更加高质量的数据来训练 LLM</p>
</blockquote>
<p><a class="glightbox" href="../../images/2-2-11.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-11.png" /></a></p>
<ul>
<li><span class="arithmatex">\(v_k\)</span>: 部分解<span class="arithmatex">\(p_k=[s_1,s_2,...,s_k]\)</span>的质量；</li>
<li><span class="arithmatex">\(m_k\)</span>: 部分解<span class="arithmatex">\(p_k\)</span>的推理距离<span class="arithmatex">\(m_k\)</span>为从<span class="arithmatex">\(p_k\)</span>开始，策略模型达到正确答案所需的最小推理步数；</li>
<li><span class="arithmatex">\(w_{s_k}\)</span>: 单步加权奖励<span class="arithmatex">\(w_{s_k}\)</span>，反映当前步骤<span class="arithmatex">\(s_k\)</span>的质量，基于常见的 PRM 奖励<span class="arithmatex">\(r_{s_k}\)</span>，进一步将推理距离作为权重因子，反应<span class="arithmatex">\(s_k\)</span>的增量进展；</li>
</ul>
<p><strong>Quality Value 的计算</strong></p>
<div class="arithmatex">\[v_k = \begin{cases} 
0, &amp; k=0 \\
\max(v_{k-1}+w_{s_k}, 0), &amp; \text{else}
\end{cases}\]</div>
<div class="arithmatex">\[UCB(i) = v_i + c\sqrt{\frac{\ln N_i}{n_i}}\]</div>
<p><strong>Weighted Reward 的计算</strong></p>
<div class="arithmatex">\[w_{s_k} = \frac{m_{k+1}}{1-v_{k-1}}(1-2r_{s_k}),  k=1,2,\cdots\]</div>
<p>其中，<span class="arithmatex">\(m_k=K-k\)</span>，<span class="arithmatex">\(K\)</span>是解决方案<span class="arithmatex">\(s\)</span>的总推理步数，<span class="arithmatex">\(r_{s_k}\)</span>沿用了MATH-SHEPHERD的方法。</p>
<p>所以，一旦我们有了精确的<span class="arithmatex">\(r_{s_k}\)</span>(PRM) 和<span class="arithmatex">\(m_k\)</span>的预估，就可以直接预测部分解决方案<span class="arithmatex">\(p_k\)</span>的质量值<span class="arithmatex">\(v_k\)</span>来引导搜索，并且可以简单地训练一个过程奖励模型<span class="arithmatex">\(V_\theta\)</span>来预测<span class="arithmatex">\(v_k\)</span>，作为常见 PRM 的一种变体。</p>
<p><strong>训练流程 Step0</strong></p>
<p><a class="glightbox" href="../../images/2-2-12.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-12.png" /></a></p>
<p>初始时刻用 BFS 构建搜索树，根据数据的标签验证所有叶节点的答案是否正确，计算<span class="arithmatex">\(m_k\)</span>和使用硬估计（Hard Estimation）方法计算<span class="arithmatex">\(r_{s_k}\)</span>，按照上述公式计算<span class="arithmatex">\(v_k\)</span>。将所有提取的部分解决方案及其质量值<span class="arithmatex">\(v_k\)</span>组合成训练集<span class="arithmatex">\(DV_0\)</span>。这些数据用于训练初始值过程奖励模型<span class="arithmatex">\(V_\theta\)</span>，使其能够评估部分解决方案的质量:</p>
<div class="arithmatex">\[L_{MSE} = E_{(q,p,v)\sim DV_0}|V_\theta(p|q)-v|^2\]</div>
<p><a class="glightbox" href="../../images/2-2-13.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-13.png" /></a></p>
<p><a class="glightbox" href="../../images/2-2-14.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-14.png" /></a></p>
<p><strong>训练流程 Step1</strong></p>
<p>由于不想直接像 AlphaZero 一样简化掉 Simulation 阶段，所以最关键的步骤为 MCTS* 中的贪婪蒙特卡洛展开 (Greedy MC Rollout)，从扩展的节点C′开始，逐步生成推理步骤，并使用过程奖励模型<span class="arithmatex">\(V_\theta\)</span>评估每一步的质量值。记录模拟过程中获得的最大质量值<span class="arithmatex">\(v_{max}\)</span>，使用加权平均方法更新节点的质量值：</p>
<div class="arithmatex">\[v_{C'} = \alpha v_{C'} + (1-\alpha)v_{max}\]</div>
<p>Greedy MC Rollout 通过选择最有价值的推理路径，减少了搜索空间，提升了搜索效率。</p>
<p><strong>训练流程 Step2</strong></p>
<p><a class="glightbox" href="../../images/2-2-15.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-15.png" /></a></p>
<p><a class="glightbox" href="../../images/2-2-16.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-16.png" /></a></p>
<p><a class="glightbox" href="../../images/2-2-17.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-17.png" /></a></p>
<p>重复 step1 和 step2，最终得到训练好的策略模型和过程奖励模型</p>
<p><a class="glightbox" href="../../images/2-2-18.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-18.png" /></a></p>
<h4 id="alphazero-llm">把 AlphaZero 的策略迁移到 LLM<a class="headerlink" href="#alphazero-llm" title="Permanent link">&para;</a></h4>
<h4 id="super_mario">Super_MARIO<a class="headerlink" href="#super_mario" title="Permanent link">&para;</a></h4>
<blockquote>
<p>迁移 AlphaZero 的范式，迭代训练 Step-level Value Model <span class="arithmatex">\(V_\phi(s)\)</span> 和策略模型 <span class="arithmatex">\(\pi_\theta\)</span>，且两者是具有不同最终层的相同模型</p>
</blockquote>
<p><a class="glightbox" href="../../images/2-2-19.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-19.png" /></a></p>
<p><strong>状态更新 <span class="arithmatex">\(f(s_{t+1}|s_t,a_t)\)</span></strong></p>
<div class="arithmatex">\[\pi_\theta(a_t|s_t) = LLM(a_t|s_t), s_{t+1} = Cat(s_t, a_t)\]</div>
<p><strong>Step-level Value Model <span class="arithmatex">\(V_\phi(s)\)</span></strong></p>
<p>创建训练信号的方法是使用 MCTS 中的 Simulation 思想，其中，<span class="arithmatex">\(r(\cdot|s_t)\)</span>表示表示从状态<span class="arithmatex">\(s_t\)</span>开始，一次模拟中最终结果的奖励：</p>
<div class="arithmatex">\[V(s_t) = \frac{1}{N}\sum_{i=1}^N r(a_{t'\geq t}^{(i)}, s_{t'&gt;t}^{(i)}|s_t)\]</div>
<p>对于任何给定的部分回复<span class="arithmatex">\(s\)</span>，使用以下回归损失来训练 Step-level Value Model <span class="arithmatex">\(V_\phi(s)\)</span>：</p>
<div class="arithmatex">\[L_{V_\phi}(s) = (V_\phi(s) - V(s))^2\]</div>
<p><strong>PUCT algorithm</strong></p>
<p><a class="glightbox" href="../../images/2-2-20.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-20.png" /></a></p>
<p>在 Selection 阶段，根据 PUCT 算法来探索树 <span class="arithmatex">\(T_k\)</span>：</p>
<div class="arithmatex">\[a_t = \arg\max_{a \in T_k} \left[Q^*(s_t, a) + c_{puct} \pi_{\theta_k}(a|s_t) \frac{\sqrt{N_{parent}(a)}}{1+N(s_t, a)} \right]\]</div>
<p>其中，先验<span class="arithmatex">\(\pi(a|s_t)\)</span>被定义为步骤<span class="arithmatex">\(a\)</span>中所有 token 的对数概率的平均值的指数：</p>
<div class="arithmatex">\[\exp\left(\frac{1}{|a|}\sum \log \pi(a_j|a_{&lt;j}, s_t)\right)\]</div>
<p>在选择阶段之后识别出的叶节点<span class="arithmatex">\(s_t\)</span>的评估：</p>
<div class="arithmatex">\[V^*(s_t)^{(i)} = (1-\lambda) \cdot V_{\phi_k}(s_t) + \lambda \cdot r(a_{t'\geq t}^{(i)}, s_{t'&gt;t}^{(i)}|s_t)\]</div>
<p>MCTS 中的中间价值估计<span class="arithmatex">\(V^*\)</span>和 Value Model 的训练信号<span class="arithmatex">\(V\)</span>不同，参数<span class="arithmatex">\(\lambda\)</span>用于平衡价值模型估计与 Simulation 过程中获得的经验奖励的贡献，<span class="arithmatex">\(\lambda\)</span>采用了与 AlphaZero 相同的策略。但LLM推理的树深度远比围棋游戏浅（例如，最大深度为8），且容易到达终止节点，所以设置指示函数<span class="arithmatex">\(\lambda = I_{terminal}(s_t)\)</span>，如果扩展的节点是终端节点，则返回奖励；否则，价值由模型<span class="arithmatex">\(V_{\phi_k}\)</span>预测。</p>
<p><strong>Backup 策略</strong></p>
<p>完全参考AlphaZero的策略：</p>
<div class="arithmatex">\[N(s,a) \leftarrow N(s,a) + 1\]</div>
<div class="arithmatex">\[Q^*(s,a) \leftarrow \frac{1}{N(s,a)}\sum_{j=1}^i I_{s,a \rightarrow s_t} V^*(s_t)^{(j)}\]</div>
<p><strong>价值估计</strong></p>
<p>运行了N次模拟后，得到了最终的搜索树<span class="arithmatex">\(T_k\)</span>，<span class="arithmatex">\(Q(s_t,a_t)\)</span>表示在状态<span class="arithmatex">\(s_t\)</span>下采取动作<span class="arithmatex">\(a_t\)</span>所能获得的预期回报，这个值是根据贝尔曼方程计算的，故对于非终止节点：</p>
<div class="arithmatex">\[Q(s_t,a_t) = r(s_t,a_t) + V(s_{t+1}) = V(s_{t+1})\]</div>
<p>于是可以直接拟合非终止节点的 State-Action Value：</p>
<div class="arithmatex">\[V(s_{t+1}) = Q^*(s_t,a_t)\]</div>
<p><strong>迭代训练</strong></p>
<p><a class="glightbox" href="../../images/2-2-21.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-21.png" /></a></p>
<p>以一个预训练的语言模型（LLM）作为策略模型 <span class="arithmatex">\(\pi_{\theta_1}\)</span>开始，添加了一个辅助线性层用于预测<span class="arithmatex">\(V\)</span>，策略模型<span class="arithmatex">\(\pi_\theta\)</span>和价值模型<span class="arithmatex">\(V_\phi\)</span>共享了大部分参数。随着 MCTS 轮次中的模拟不断进行，终止节点的奖励(<span class="arithmatex">\(\pm1\)</span>)会被回传到其祖先节点，中间节点的估计值<span class="arithmatex">\(Q^*\)</span>会逐渐收敛到真实的值，并且该值范围在<span class="arithmatex">\([-1,1]\)</span>之间。</p>
<p><strong>训练方法</strong></p>
<p>从第<span class="arithmatex">\(k\)</span>轮 MCTS 构建的搜索树<span class="arithmatex">\(T_k\)</span>中，采样出对应于终止节点的解路径，这些路径包括预测答案正确的路径（<span class="arithmatex">\(x^+\)</span>）和预测答案错误的路径（<span class="arithmatex">\(x^-\)</span>），以及这些路径上每个节点的价值估计。使用一个多任务损失函数来同时更新策略模型和价值模型:</p>
<div class="arithmatex">\[
\arg\min_{\theta,\phi} -\log\pi_\theta(x^+|q) + \beta \cdot \left(\sum_{t=1}^{T(x^+)} \|V_\phi(s_t)-V(s_t)\|^2 + \sum_{t=1}^{T(x^-)} \|V_\phi(s_t)-V(s_t)\|^2\right)
\]</div>
<p>其中<span class="arithmatex">\(T(x)\)</span>表示解路径<span class="arithmatex">\(x\)</span>的步数，得到新的<span class="arithmatex">\(\pi_{\theta_{k+1}}\)</span>和<span class="arithmatex">\(V_{\phi_{k+1}}\)</span>后，开始下一轮 MCTS。</p>
<p><a class="glightbox" href="../../images/2-2-22.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="../../images/2-2-22.png" /></a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Datawhale Unlock-DeepSeek Team
    </div>
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "announce.dismiss", "navigation.tracking", "navigation.tabs", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>